-- Client-only, runtime UI. Needs LocalPlayer, RenderStepped, HumanoidRootPart.
local Players=game:GetService("Players")
local RunService=game:GetService("RunService")
local UIS=game:GetService("UserInputService")
local player=Players.LocalPlayer
local character=player.Character or player.CharacterAdded:Wait()
local hrp=character:WaitForChild("HumanoidRootPart")
local humanoid=character:WaitForChild("Humanoid")

print("[FlySuite] script parent:", script.Parent and script.Parent:GetFullName() or "nil (memory-only)")

local pg=player:WaitForChild("PlayerGui")
local gui=Instance.new("ScreenGui"); gui.Name="FlySuiteUI"; gui.ResetOnSpawn=false; gui.ZIndexBehavior=Enum.ZIndexBehavior.Sibling; gui.DisplayOrder=9999; gui.Parent=pg
print("[FlySuite] UI parent:", gui.Parent and gui.Parent:GetFullName() or "nil")

local C_PRIMARY=Color3.fromRGB(0,170,255)
local C_BG=Color3.fromRGB(20,22,26)
local C_BAR=Color3.fromRGB(30,33,38)
local C_TEXT=Color3.new(1,1,1)
local C_STOP=Color3.fromRGB(220,110,110)
local function corner(p,r) local c=Instance.new("UICorner"); c.CornerRadius=UDim.new(0,r or 8); c.Parent=p end
local function stroke(p,t) local s=Instance.new("UIStroke"); s.Thickness=t or 1; s.Color=Color3.fromRGB(60,65,70); s.Transparency=0.2; s.Parent=p end

-- Globals/state
local mode="none" -- "pc" or "phone"
local flying=false
local speed=70
local flyConn,hDiedConn
local rootAttachment,alignOrientation,linearVelocity,liftForce
local kbConns={}
local keyState={W=false,A=false,S=false,D=false}

local controls
local function getControls()
	if controls then return controls end
	local ps=player:FindFirstChild("PlayerScripts"); local pm=ps and ps:FindFirstChild("PlayerModule")
	if pm then controls=require(pm):GetControls() end
	return controls
end

local function cleanFly()
	if flyConn then flyConn:Disconnect() flyConn=nil end
	if alignOrientation then alignOrientation:Destroy() alignOrientation=nil end
	if linearVelocity then linearVelocity:Destroy() linearVelocity=nil end
	if liftForce then liftForce:Destroy() liftForce=nil end
	if rootAttachment then rootAttachment:Destroy() rootAttachment=nil end
	if humanoid then humanoid.AutoRotate=true end
end

local function desiredDir(camCF)
	if mode=="pc" then
		local z=(keyState.S and 1 or 0)-(keyState.W and 1 or 0)
		local x=(keyState.D and 1 or 0)-(keyState.A and 1 or 0)
		local v=camCF.RightVector*x + camCF.LookVector*(-z)
		return (v.Magnitude>1e-3) and v.Unit or Vector3.zero
	elseif mode=="phone" then
		local m=getControls() and getControls():GetMoveVector() or Vector3.zero
		local forward=math.max(0,-m.Z) -- forward only
		local strafe=m.X
		local v=camCF.RightVector*strafe + camCF.LookVector*forward
		return (v.Magnitude>1e-3) and v.Unit or Vector3.zero
	end
	return Vector3.zero
end

local function startFlying()
	if flying then return end
	flying=true
	rootAttachment=Instance.new("Attachment"); rootAttachment.Name="FlyAttachment"; rootAttachment.Parent=hrp
	alignOrientation=Instance.new("AlignOrientation"); alignOrientation.Attachment0=rootAttachment; alignOrientation.Mode=Enum.OrientationAlignmentMode.OneAttachment; alignOrientation.Responsiveness=60; alignOrientation.MaxTorque=math.huge; alignOrientation.Parent=hrp
	linearVelocity=Instance.new("LinearVelocity"); linearVelocity.Attachment0=rootAttachment; linearVelocity.MaxForce=math.huge; linearVelocity.RelativeTo=Enum.ActuatorRelativeTo.World; linearVelocity.VectorVelocity=Vector3.zero; linearVelocity.Parent=hrp
	liftForce=Instance.new("VectorForce"); liftForce.Attachment0=rootAttachment; liftForce.RelativeTo=Enum.ActuatorRelativeTo.World; liftForce.Force=Vector3.zero; liftForce.Parent=hrp
	humanoid.AutoRotate=false
	flyConn=RunService.RenderStepped:Connect(function()
		if not flying then return end
		local cam=workspace.CurrentCamera; local camCF=(cam and cam.CFrame) or hrp.CFrame
		local dir=desiredDir(camCF)
		linearVelocity.VectorVelocity=dir*speed
		local face=(dir.Magnitude>1e-3) and dir or camCF.LookVector
		alignOrientation.CFrame=CFrame.lookAt(hrp.Position,hrp.Position+face)
		liftForce.Force=Vector3.new(0,hrp.AssemblyMass*workspace.Gravity,0)
		if humanoid:GetState()~=Enum.HumanoidStateType.Freefall then humanoid:ChangeState(Enum.HumanoidStateType.Freefall) end
	end)
end

local function stopFlying() if not flying then return end flying=false; cleanFly() end

local function hookHumanoid(h)
	if hDiedConn then hDiedConn:Disconnect() hDiedConn=nil end
	hDiedConn=h.Died:Connect(function() if flying then print("[FlySuite] Died: stopping fly") end; stopFlying() end)
end
hookHumanoid(humanoid)
player.CharacterAdded:Connect(function(c)
	character=c; hrp=c:WaitForChild("HumanoidRootPart"); humanoid=c:WaitForChild("Humanoid"); hookHumanoid(humanoid)
	if flying then stopFlying() task.wait(0.15) startFlying() end
end)

-- Drag helper
local function makeDraggable(frame,handles)
	local dragging=false; local dragStart; local startPos
	local function begin(input)
		if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
			dragging=true; dragStart=input.Position; startPos=frame.Position
			local con; con=input.Changed:Connect(function()
				if input.UserInputState==Enum.UserInputState.End then dragging=false if con then con:Disconnect() end end
			end)
		end
	end
	local function move(input)
		if not dragging then return end
		if input.UserInputType==Enum.UserInputType.MouseMovement or input.UserInputType==Enum.UserInputType.Touch then
			local d=input.Position-dragStart
			frame.Position=UDim2.new(startPos.X.Scale,startPos.X.Offset+d.X,startPos.Y.Scale,startPos.Y.Offset+d.Y)
		end
	end
	for _,h in ipairs(handles) do
		h.InputBegan:Connect(begin)
		h.InputChanged:Connect(move)
	end
end

-- Panel builder (shared look)
local function buildPanel(titleText,name)
	local panel=Instance.new("Frame"); panel.Name=name or "Panel"; panel.AnchorPoint=Vector2.new(0.5,0.5); panel.Position=UDim2.new(0.5,0,0.5,0)
	panel.Size=UDim2.fromOffset(280,150); panel.BackgroundColor3=C_BG; panel.BorderSizePixel=0; panel.Parent=gui; corner(panel,10); stroke(panel,1)
	local bar=Instance.new("Frame"); bar.Name="Bar"; bar.BackgroundColor3=C_BAR; bar.BorderSizePixel=0; bar.Size=UDim2.new(1,0,0,32); bar.Parent=panel
	local title=Instance.new("TextLabel"); title.BackgroundTransparency=1; title.TextXAlignment=Enum.TextXAlignment.Left
	title.Font=Enum.Font.GothamMedium; title.TextColor3=C_TEXT; title.TextSize=14; title.Text=titleText; title.Size=UDim2.new(1,-44,1,0); title.Position=UDim2.new(0,10,0,0); title.Parent=bar
	local close=Instance.new("TextButton"); close.Size=UDim2.fromOffset(24,24); close.Position=UDim2.new(1,-28,0.5,-12); close.Text="X"
	close.BackgroundColor3=Color3.fromRGB(70,40,40); close.TextColor3=C_TEXT; close.Font=Enum.Font.GothamBold; close.TextSize=16; close.Parent=bar; corner(close,6)
	makeDraggable(panel,{bar})
	return panel,bar,close
end

-- Loader (bouncing dots)
local loader=Instance.new("Frame"); loader.Name="Loader"; loader.AnchorPoint=Vector2.new(0.5,0.5); loader.Position=UDim2.new(0.5,0,0.5,0)
loader.Size=UDim2.fromOffset(140,44); loader.BackgroundTransparency=1; loader.Parent=gui
local function mkDot(x) local d=Instance.new("Frame"); d.Size=UDim2.fromOffset(12,12); d.Position=UDim2.new(0,x,0.5,0); d.AnchorPoint=Vector2.new(0,0.5); d.BackgroundColor3=C_PRIMARY; d.BorderSizePixel=0; d.Parent=loader; corner(d,6); return d end
local dot1=mkDot(32); local dot2=mkDot(64); local dot3=mkDot(96)
local startT=os.clock()
local loaderConn=RunService.RenderStepped:Connect(function()
	local t=os.clock()-startT
	local function y(ph) return math.sin((t*6)+ph)*8 end
	dot1.Position=UDim2.new(0,32,0.5,y(0))
	dot2.Position=UDim2.new(0,64,0.5,y(0.5))
	dot3.Position=UDim2.new(0,96,0.5,y(1))
end)

-- Choice UI
local function showChoice()
	if loaderConn then loaderConn:Disconnect() loaderConn=nil end
	if loader then loader:Destroy() end
	local panel,bar,close=buildPanel("Choose Input","ChoicePanel")
	local prompt=Instance.new("TextLabel"); prompt.BackgroundTransparency=1; prompt.TextColor3=C_TEXT; prompt.Font=Enum.Font.Gotham; prompt.TextSize=16
	prompt.Text="Are you on PC/Emulator or Phone?"; prompt.Size=UDim2.new(1,-20,0,24); prompt.Position=UDim2.new(0,10,0,46); prompt.Parent=panel
	local pcBtn=Instance.new("TextButton"); pcBtn.Size=UDim2.new(0.5,-15,0,44); pcBtn.Position=UDim2.new(0,10,0,86); pcBtn.Text="PC / Emulator"
	pcBtn.BackgroundColor3=C_PRIMARY; pcBtn.TextColor3=C_TEXT; pcBtn.Font=Enum.Font.GothamBold; pcBtn.TextSize=16; pcBtn.AutoButtonColor=true; pcBtn.Parent=panel; corner(pcBtn,8)
	local phBtn=Instance.new("TextButton"); phBtn.Size=UDim2.new(0.5,-15,0,44); phBtn.Position=UDim2.new(0.5,5,0,86); phBtn.Text="Phone"
	phBtn.BackgroundColor3=C_PRIMARY; phBtn.TextColor3=C_TEXT; phBtn.Font=Enum.Font.GothamBold; phBtn.TextSize=16; phBtn.AutoButtonColor=true; phBtn.Parent=panel; corner(phBtn,8)

	local function destroyAll() stopFlying(); gui:Destroy(); _G.FlySuite=nil; task.defer(function() if script and script.Destroy then script:Destroy() end end) end
	close.MouseButton1Click:Connect(destroyAll)

	pcBtn.MouseButton1Click:Connect(function()
		mode="pc"; print("[FlySuite] Mode = PC/Emulator")
		panel:Destroy()
		task.defer(function() -- ensure clean transition
			local function onKey(b,down)
				if b==Enum.KeyCode.W then keyState.W=down elseif b==Enum.KeyCode.A then keyState.A=down
				elseif b==Enum.KeyCode.S then keyState.S=down elseif b==Enum.KeyCode.D then keyState.D=down end
			end
			for _,c in ipairs(kbConns) do c:Disconnect() end; table.clear(kbConns)
			table.insert(kbConns, UIS.InputBegan:Connect(function(i,gp) if gp then return end if i.UserInputType==Enum.UserInputType.Keyboard then onKey(i.KeyCode,true) end end))
			table.insert(kbConns, UIS.InputEnded:Connect(function(i,gp) if gp then return end if i.UserInputType==Enum.UserInputType.Keyboard then onKey(i.KeyCode,false) end end))
			local p=buildFlyUI("Fly (PC)","FlyPCPanel")
			-- no extra actions
		end)
	end)

	phBtn.MouseButton1Click:Connect(function()
		mode="phone"; print("[FlySuite] Mode = Phone")
		panel:Destroy()
		task.defer(function()
			for _,c in ipairs(kbConns) do c:Disconnect() end; table.clear(kbConns)
			local p=buildFlyUI("Fly (Phone)","FlyPhonePanel")
			-- no extra actions
		end)
	end)
end

-- Shared Fly UI (same look, different name/title)
function buildFlyUI(titleText,name)
	local panel,bar,close=buildPanel(titleText,name)
	local toggle=Instance.new("TextButton"); toggle.Name="Toggle"; toggle.Size=UDim2.new(1,-20,0,50); toggle.Position=UDim2.new(0,10,0,56)
	toggle.BackgroundColor3=C_PRIMARY; toggle.TextColor3=C_TEXT; toggle.Font=Enum.Font.GothamBold; toggle.TextSize=18; toggle.Text="Enable Fly"; toggle.Parent=panel; corner(toggle,8)

	local function updateBtn() toggle.Text = flying and "Disable Fly" or "Enable Fly"; toggle.BackgroundColor3 = flying and C_STOP or C_PRIMARY end
	updateBtn()

	toggle.MouseButton1Click:Connect(function() if flying then stopFlying() else startFlying() end updateBtn() end)
	close.MouseButton1Click:Connect(function()
		stopFlying()
		for _,c in ipairs(kbConns) do c:Disconnect() end; table.clear(kbConns)
		gui:Destroy(); _G.FlySuite=nil; task.defer(function() if script and script.Destroy then script:Destroy() end end)
	end)

	-- Expose simple controls
	_G.FlySuite=_G.FlySuite or {}
	_G.FlySuite.Toggle=function() if flying then stopFlying() else startFlying() end updateBtn() end
	_G.FlySuite.Start=function() if not flying then startFlying() updateBtn() end end
	_G.FlySuite.Stop=function() if flying then stopFlying() updateBtn() end end
	_G.FlySuite.SetSpeed=function(v) speed=math.clamp(tonumber(v) or speed,10,300) end

	return panel
end

-- Kick things off
task.delay(1.2,showChoice)
