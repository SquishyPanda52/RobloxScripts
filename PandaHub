-- LocalScript (place in StarterPlayerScripts)
local player = game.Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local uis = game:GetService("UserInputService")
local runService = game:GetService("RunService")

-- UI Setup
local screenGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
screenGui.Name = "FlyToggleUI"

-----------------------------------------------------------------
-- All code below is runtime‑generated: UI + Fly mechanics
-- Mobile‑friendly: draggable when open, collapses to "+" button
-----------------------------------------------------------------

-- State
local flying = false
local panelOpen = true
local ascendHeld, descendHeld = false, false
local speed = 70
local verticalSpeed = 50

-- Main UI Panel
local panel = Instance.new("Frame")
panel.AnchorPoint = Vector2.new(0.5, 1)
panel.Position = UDim2.new(0.5, 0, 1, -150)
panel.Size = UDim2.fromOffset(200, 140)
panel.BackgroundColor3 = Color3.fromRGB(20, 22, 26)
panel.Parent = screenGui

local collapseBtn = Instance.new("TextButton")
collapseBtn.Size = UDim2.fromOffset(26, 26)
collapseBtn.Position = UDim2.new(1, -30, 0, 4)
collapseBtn.Text = "-"
collapseBtn.Parent = panel

-- Toggle Fly Button
local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(1, -12, 0, 40)
toggleBtn.Position = UDim2.new(0, 6, 0, 36)
toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
toggleBtn.TextColor3 = Color3.new(1,1,1)
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.Text = "Enable Fly"
toggleBtn.Parent = panel

-- Up / Down buttons
local upBtn = Instance.new("TextButton")
upBtn.Size = UDim2.new(0.5, -8, 0, 40)
upBtn.Position = UDim2.new(0, 6, 0, 80)
upBtn.BackgroundColor3 = Color3.fromRGB(90, 190, 110)
upBtn.Text = "↑ Up"
upBtn.Parent = panel

local downBtn = Instance.new("TextButton")
downBtn.Size = UDim2.new(0.5, -8, 0, 40)
downBtn.Position = UDim2.new(0.5, 2, 0, 80)
downBtn.BackgroundColor3 = Color3.fromRGB(220, 110, 110)
downBtn.Text = "↓ Down"
downBtn.Parent = panel

-- Collapsed "+" button
local collapsedBtn = Instance.new("TextButton")
collapsedBtn.Size = UDim2.fromOffset(44, 44)
collapsedBtn.AnchorPoint = Vector2.new(0.5, 1)
collapsedBtn.Position = panel.Position
collapsedBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
collapsedBtn.Text = "+"
collapsedBtn.Visible = false
collapsedBtn.Parent = screenGui

-- Panel open/close
local function setPanelOpen(open)
    panelOpen = open
    panel.Visible = open
    collapsedBtn.Visible = not open
    collapseBtn.Text = open and "-" or "+"
end
collapseBtn.MouseButton1Click:Connect(function()
    setPanelOpen(false)
end)
collapsedBtn.MouseButton1Click:Connect(function()
    setPanelOpen(true)
end)

-- Draggable only when open
local dragging, dragStart, startPos
panel.InputBegan:Connect(function(input)
    if panelOpen and (input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch) then
        dragging = true
        dragStart = input.Position
        startPos = panel.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)
panel.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        panel.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- Physics parts
local rootAttachment
local alignOrientation
local linearVelocity

local function startFlying()
    if flying then return end
    flying = true
    toggleBtn.Text = "Disable Fly"

    rootAttachment = Instance.new("Attachment")
    rootAttachment.Parent = humanoidRootPart

    alignOrientation = Instance.new("AlignOrientation")
    alignOrientation.Attachment0 = rootAttachment
    alignOrientation.Mode = Enum.OrientationAlignmentMode.OneAttachment
    alignOrientation.Responsiveness = 50
    alignOrientation.Parent = humanoidRootPart

    linearVelocity = Instance.new("LinearVelocity")
    linearVelocity.Attachment0 = rootAttachment
    linearVelocity.MaxForce = math.huge
    linearVelocity.RelativeTo = Enum.ActuatorRelativeTo.World
    linearVelocity.Parent = humanoidRootPart

    runService.RenderStepped:Connect(function()
        if not flying then return end
        local camCF = workspace.CurrentCamera.CFrame
        local moveDir = player:FindFirstChild("PlayerScripts")
            and require(player.PlayerScripts:WaitForChild("PlayerModule")):GetControls():GetMoveVector()
            or Vector3.zero

        local flatLook = Vector3.new(camCF.LookVector.X, 0, camCF.LookVector.Z).Unit
        local flatRight = Vector3.new(camCF.RightVector.X, 0, camCF.RightVector.Z).Unit
        local planarDir = (flatRight * moveDir.X + flatLook * moveDir.Z)
        if planarDir.Magnitude > 1 then planarDir = planarDir.Unit end

        local vy = ascendHeld and verticalSpeed or (descendHeld and -verticalSpeed or 0)
        local desiredVel = planarDir * speed + Vector3.new(0, vy, 0)
        linearVelocity.VectorVelocity = desiredVel

        local targetCF = CFrame.lookAt(humanoidRootPart.Position, humanoidRootPart.Position + (desiredVel.Magnitude > 1 and planarDir or flatLook))
        alignOrientation.CFrame = targetCF
    end)
end

local function stopFlying()
    if not flying then return end
    flying = false
    toggleBtn.Text = "Enable Fly"
    if alignOrientation then alignOrientation:Destroy() end
    if linearVelocity then linearVelocity:Destroy() end
    if rootAttachment then rootAttachment:Destroy() end
end

toggleBtn.MouseButton1Click:Connect(function()
    if flying then stopFlying() else startFlying() end
end)
upBtn.MouseButton1Down:Connect(function() ascendHeld = true end)
upBtn.MouseButton1Up:Connect(function() ascendHeld = false end)
downBtn.MouseButton1Down:Connect(function() descendHeld = true end)
downBtn.MouseButton1Up:Connect(function() descendHeld = false end)
