--[[ ESP Executor Script (respawn-robust, red+transparent fill, long-range names)
  - Collapsible "ESP +" bar, draggable (min + restore)
  - X fully deletes UI and script
  - ESP toggle + team whitelist filter (comma separated)
  - Respawn-safe: retries on CharacterAdded until Humanoid/parts exist
  - Fill is RED and more transparent; name tags visible from farther away
]]

-- Tunables
local FILL_COLOR = Color3.fromRGB(255, 0, 0)  -- red fill
local FILL_TRANSPARENCY = 0.85                -- more transparent (0=solid, 1=invisible)
local NAME_MAX_DISTANCE = 2000                -- farther name visibility (if property exists)

-- Services
local Players   = game:GetService("Players")
local UserInput = game:GetService("UserInputService")

local localPlayer = Players.LocalPlayer
local playerGui   = localPlayer:WaitForChild("PlayerGui")

-- State
local espEnabled  = false
local teamFilters = {} -- lowercase whitelist
local highlights  = {} -- [Player] = {hl=Highlight, bb=BillboardGui, conns={...}}

-- UI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ESPExecutorUI"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.DisplayOrder = 999999
screenGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 260, 0, 120)
mainFrame.Position = UDim2.new(0.35, 0, 0.35, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 26)
titleBar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleLabel = Instance.new("TextLabel")
titleLabel.BackgroundTransparency = 1
titleLabel.Size = UDim2.new(1, -60, 1, 0)
titleLabel.Position = UDim2.new(0, 8, 0, 0)
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 14
titleLabel.TextColor3 = Color3.fromRGB(235, 235, 235)
titleLabel.Text = "ESP Admin"
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Parent = titleBar

local btnMin = Instance.new("TextButton")
btnMin.Size = UDim2.new(0, 26, 0, 26)
btnMin.Position = UDim2.new(1, -52, 0, 0)
btnMin.Font = Enum.Font.GothamBold
btnMin.TextSize = 18
btnMin.Text = "-"
btnMin.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
btnMin.TextColor3 = Color3.fromRGB(240, 240, 240)
btnMin.Parent = titleBar

local btnClose = Instance.new("TextButton")
btnClose.Size = UDim2.new(0, 26, 0, 26)
btnClose.Position = UDim2.new(1, -26, 0, 0)
btnClose.Font = Enum.Font.GothamBold
btnClose.TextSize = 18
btnClose.Text = "X"
btnClose.BackgroundColor3 = Color3.fromRGB(80, 20, 20)
btnClose.TextColor3 = Color3.fromRGB(255, 200, 200)
btnClose.Parent = titleBar

local btnToggle = Instance.new("TextButton")
btnToggle.Size = UDim2.new(1, -16, 0, 30)
btnToggle.Position = UDim2.new(0, 8, 0, 36)
btnToggle.Font = Enum.Font.GothamBold
btnToggle.TextSize = 14
btnToggle.Text = "ESP: OFF"
btnToggle.BackgroundColor3 = Color3.fromRGB(80, 30, 30)
btnToggle.TextColor3 = Color3.fromRGB(240, 240, 240)
btnToggle.Parent = mainFrame

local txtFilter = Instance.new("TextBox")
txtFilter.Size = UDim2.new(1, -16, 0, 24)
txtFilter.Position = UDim2.new(0, 8, 0, 76)
txtFilter.Font = Enum.Font.Gotham
txtFilter.TextSize = 14
txtFilter.PlaceholderText = "Teams (comma separated)"
txtFilter.ClearTextOnFocus = false
txtFilter.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
txtFilter.TextColor3 = Color3.fromRGB(240, 240, 240)
txtFilter.Parent = mainFrame

-- Minimized bar
local minBar = Instance.new("TextButton")
minBar.Name = "ESPMinBar"
minBar.Size = UDim2.new(0, 100, 0, 26)
minBar.Position = mainFrame.Position
minBar.Font = Enum.Font.GothamBold
minBar.TextSize = 14
minBar.Text = "ESP +"
minBar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
minBar.TextColor3 = Color3.fromRGB(235, 235, 235)
minBar.Visible = false
minBar.Parent = screenGui

-- Dragging
local function makeDraggable(frame, handle)
  local dragging, dragInput, dragStart, startPos
  local function update(input)
    local delta = input.Position - dragStart
    frame.Position = UDim2.new(
      startPos.X.Scale, startPos.X.Offset + delta.X,
      startPos.Y.Scale, startPos.Y.Offset + delta.Y
    )
  end
  handle.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
      dragging = true
      dragStart = input.Position
      startPos = frame.Position
      input.Changed:Connect(function()
        if input.UserInputState == Enum.UserInputState.End then dragging = false end
      end)
    end
  end)
  handle.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
      dragInput = input
    end
  end)
  UserInput.InputChanged:Connect(function(input)
    if dragging and input == dragInput then update(input) end
  end)
end
makeDraggable(mainFrame, titleBar)
makeDraggable(minBar, minBar)

-- Collapse/expand
btnMin.MouseButton1Click:Connect(function()
  minBar.Position = mainFrame.Position
  mainFrame.Visible = false
  minBar.Visible = true
end)
minBar.MouseButton1Click:Connect(function()
  mainFrame.Position = minBar.Position
  mainFrame.Visible = true
  minBar.Visible = false
end)

-- Utils
local function trim(s) return (s:match("^%s*(.-)%s*$")) end
local function updateFilters(text)
  teamFilters = {}
  for name in (text or ""):lower():gmatch("([^,]+)") do
    name = trim(name)
    if name ~= "" then table.insert(teamFilters, name) end
  end
end
txtFilter:GetPropertyChangedSignal("Text"):Connect(function()
  updateFilters(txtFilter.Text)
  for plr, data in pairs(highlights) do
    local teamName = (plr.Team and plr.Team.Name:lower()) or ""
    local pass = (#teamFilters == 0) or (teamName ~= "" and table.find(teamFilters, teamName) ~= nil)
    if data.hl then data.hl.Enabled = espEnabled and pass end
    if data.bb then data.bb.Enabled = espEnabled and pass end
  end
end)
updateFilters("")

local function healthToColor(hp, maxHp)
  local frac = 0
  if maxHp and maxHp > 0 then frac = math.clamp(hp/maxHp, 0, 1) end
  return Color3.fromHSV(frac * 0.33, 1, 1) -- red->yellow->green
end

local function getAdorneePart(character)
  if not character then return nil end
  return character:FindFirstChild("Head")
      or character:FindFirstChild("HumanoidRootPart")
      or character:FindFirstChildWhichIsA("BasePart")
end

-- Character readiness helper with retry
local function waitForCharacterReady(plr, timeout)
  local t0 = os.clock()
  timeout = timeout or 10
  local char = plr.Character or plr.CharacterAdded:Wait()
  if not char then return nil end
  local humanoid = char:FindFirstChildOfClass("Humanoid")
  while not humanoid and os.clock() - t0 < timeout do
    humanoid = char:FindFirstChildOfClass("Humanoid")
    task.wait(0.1)
  end
  if not humanoid then return nil end
  local adornee = getAdorneePart(char)
  while not adornee and os.clock() - t0 < timeout do
    adornee = getAdorneePart(char)
    task.wait(0.1)
  end
  return char, humanoid, adornee
end

local function destroyESP(plr)
  local data = highlights[plr]
  if not data then return end
  if data.conns then
    for _, c in ipairs(data.conns) do pcall(function() c:Disconnect() end) end
  end
  if data.bb then pcall(function() data.bb:Destroy() end) end
  if data.hl then pcall(function() data.hl:Destroy() end) end
  highlights[plr] = nil
end

-- applyESP returns true on success
local function applyESP(plr)
  destroyESP(plr)

  local char, humanoid, _ = waitForCharacterReady(plr, 8)
  if not char or not humanoid then
    return false
  end

  -- Highlight (red + more transparent)
  local hl = Instance.new("Highlight")
  hl.Name = "ESP_Highlight"
  hl.Parent = char
  hl.FillColor = FILL_COLOR
  hl.FillTransparency = FILL_TRANSPARENCY
  hl.OutlineTransparency = 0
  hl.OutlineColor = healthToColor(humanoid.Health, humanoid.MaxHealth) -- health-based outline
  hl.Enabled = false

  -- Small name tag, longer range
  local bb = Instance.new("BillboardGui")
  bb.Name = "ESP_Name"
  bb.Size = UDim2.new(0, 80, 0, 16)
  bb.StudsOffset = Vector3.new(0, 3, 0)
  bb.AlwaysOnTop = true
  bb.Enabled = false
  pcall(function() bb.MaxDistance = NAME_MAX_DISTANCE end)

  local adornee = getAdorneePart(char)
  if adornee then
    bb.Adornee = adornee
    bb.Parent = adornee
  else
    bb.Parent = char
  end

  local nameLbl = Instance.new("TextLabel")
  nameLbl.BackgroundTransparency = 1
  nameLbl.Size = UDim2.new(1, 0, 1, 0)
  nameLbl.Font = Enum.Font.Gotham
  nameLbl.TextSize = 12
  nameLbl.Text = plr.DisplayName
  nameLbl.TextColor3 = Color3.fromRGB(255, 255, 255)
  nameLbl.TextStrokeTransparency = 0.5
  nameLbl.Parent = bb

  -- Connections
  local conns = {}
  table.insert(conns, humanoid.HealthChanged:Connect(function(hp)
    hl.OutlineColor = healthToColor(hp, humanoid.MaxHealth)
  end))
  table.insert(conns, char.ChildAdded:Connect(function(child)
    if not bb.Adornee and child:IsA("BasePart") then
      if child.Name == "Head" or child.Name == "HumanoidRootPart" then
        bb.Adornee = child
        bb.Parent = child
      end
    end
  end))
  table.insert(conns, humanoid.Died:Connect(function() destroyESP(plr) end))
  table.insert(conns, plr.CharacterRemoving:Connect(function() destroyESP(plr) end))

  highlights[plr] = { hl = hl, bb = bb, conns = conns }

  -- Visibility
  local teamName = (plr.Team and plr.Team.Name:lower()) or ""
  local pass = (#teamFilters == 0) or (teamName ~= "" and table.find(teamFilters, teamName) ~= nil)
  hl.Enabled = espEnabled and pass
  bb.Enabled = espEnabled and pass

  return true
end

-- Ensure all current players have ESP (used on toggle and safety sweep)
local function ensureESPForAll()
  for _, plr in ipairs(Players:GetPlayers()) do
    if plr ~= localPlayer and plr.Character then
      if not highlights[plr] then
        applyESP(plr)
      else
        local data = highlights[plr]
        local teamName = (plr.Team and plr.Team.Name:lower()) or ""
        local pass = (#teamFilters == 0) or (teamName ~= "" and table.find(teamFilters, teamName) ~= nil)
        if data.hl then data.hl.Enabled = espEnabled and pass end
        if data.bb then
          data.bb.Enabled = espEnabled and pass
          pcall(function() data.bb.MaxDistance = NAME_MAX_DISTANCE end)
        end
      end
    end
  end
end

-- Toggle
btnToggle.MouseButton1Click:Connect(function()
  espEnabled = not espEnabled
  btnToggle.Text = espEnabled and "ESP: ON" or "ESP: OFF"
  btnToggle.BackgroundColor3 = espEnabled and Color3.fromRGB(30, 80, 30) or Color3.fromRGB(80, 30, 30)
  if espEnabled then
    ensureESPForAll()
  else
    for _, data in pairs(highlights) do
      if data.hl then data.hl.Enabled = false end
      if data.bb then data.bb.Enabled = false end
    end
  end
end)

-- Close
btnClose.MouseButton1Click:Connect(function()
  espEnabled = false
  for plr in pairs(highlights) do destroyESP(plr) end
  screenGui:Destroy()
  pcall(function() script:Destroy() end)
end)

-- Wiring: respawn-safe with retries
local function startRespawnBinder(plr)
  plr.CharacterAdded:Connect(function()
    task.spawn(function()
      local deadline = os.clock() + 10
      while os.clock() < deadline do
        if applyESP(plr) then break end
        task.wait(0.25)
      end
    end)
  end)

  plr.CharacterAppearanceLoaded:Connect(function()
    if not highlights[plr] then
      task.defer(function() applyESP(plr) end)
    else
      -- ensure long-range name remains applied
      local data = highlights[plr]
      if data and data.bb then pcall(function() data.bb.MaxDistance = NAME_MAX_DISTANCE end) end
    end
  end)

  plr:GetPropertyChangedSignal("Team"):Connect(function()
    local data = highlights[plr]
    if data then
      local teamName = (plr.Team and plr.Team.Name:lower()) or ""
      local pass = (#teamFilters == 0) or (teamName ~= "" and table.find(teamFilters, teamName) ~= nil)
      if data.hl then data.hl.Enabled = espEnabled and pass end
      if data.bb then data.bb.Enabled = espEnabled and pass end
    end
  end)

  if plr.Character then
    task.defer(function() applyESP(plr) end)
  end
end

Players.PlayerAdded:Connect(function(plr)
  if plr ~= localPlayer then startRespawnBinder(plr) end
end)
Players.PlayerRemoving:Connect(function(plr) destroyESP(plr) end)
for _, plr in ipairs(Players:GetPlayers()) do
  if plr ~= localPlayer then startRespawnBinder(plr) end
end
