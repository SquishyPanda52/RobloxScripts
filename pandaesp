--[[ ESP Executor Script (UI-mount hardened)
  - Safe parent (PlayerGui -> CoreGui fallback)
  - High DisplayOrder + IgnoreGuiInset
  - Draggable, collapsible "ESP +" bar
  - Full ESP toggle + team whitelist
  - Auto-wrap new characters, cleanup on death/leave
  - Hotkey: RightControl toggles panel visibility (safety)
]]

--// Services
local Players    = game:GetService("Players")
local UserInput  = game:GetService("UserInputService")

local localPlayer = Players.LocalPlayer

-- Wait for PlayerGui, but don't stall forever
local playerGui = nil
do
  local ok = pcall(function()
    local p = localPlayer:WaitForChild("PlayerGui", 5)
    if p then playerGui = p end
  end)
end

--// UI container with safe parent + top-layer visuals
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "Gui_" .. math.random(100000, 999999)
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
screenGui.Enabled = true
screenGui.DisplayOrder = 999999

local function tryParentTo(target)
  local ok = false
  if target then
    ok = pcall(function() screenGui.Parent = target end)
  end
  return ok
end

-- Prefer PlayerGui; if blocked, try CoreGui
if not tryParentTo(playerGui) then
  pcall(function()
    tryParentTo(game:GetService("CoreGui"))
  end)
end

-- Bail if still not parented (should be extremely rare)
if not screenGui.Parent then
  warn("ESP UI: Failed to parent ScreenGui")
  return
end

--// State
local espEnabled  = false
local teamFilters = {} -- lowercase whitelist
local highlights  = {} -- [Player] = {hl=Highlight, bb=BillboardGui, conns={...}}

--// UI: Build
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 260, 0, 120)
mainFrame.Position = UDim2.new(0.35, 0, 0.35, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BorderSizePixel = 0
mainFrame.Visible = true
mainFrame.Active = true
mainFrame.Parent = screenGui

local titleBar = Instance.new("Frame")
titleBar.Name = "TitleBar"
titleBar.Size = UDim2.new(1, 0, 0, 26)
titleBar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
titleBar.BorderSizePixel = 0
titleBar.Active = true
titleBar.Parent = mainFrame

local titleLabel = Instance.new("TextLabel")
titleLabel.BackgroundTransparency = 1
titleLabel.Size = UDim2.new(1, -60, 1, 0)
titleLabel.Position = UDim2.new(0, 8, 0, 0)
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 14
titleLabel.TextColor3 = Color3.fromRGB(235, 235, 235)
titleLabel.Text = "ESP Admin"
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.ZIndex = 2
titleLabel.Parent = titleBar

local btnMin = Instance.new("TextButton")
btnMin.Size = UDim2.new(0, 26, 0, 26)
btnMin.Position = UDim2.new(1, -52, 0, 0)
btnMin.Font = Enum.Font.GothamBold
btnMin.TextSize = 18
btnMin.Text = "-"
btnMin.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
btnMin.TextColor3 = Color3.fromRGB(240, 240, 240)
btnMin.ZIndex = 2
btnMin.Parent = titleBar

local btnClose = Instance.new("TextButton")
btnClose.Size = UDim2.new(0, 26, 0, 26)
btnClose.Position = UDim2.new(1, -26, 0, 0)
btnClose.Font = Enum.Font.GothamBold
btnClose.TextSize = 18
btnClose.Text = "X"
btnClose.BackgroundColor3 = Color3.fromRGB(80, 20, 20)
btnClose.TextColor3 = Color3.fromRGB(255, 200, 200)
btnClose.ZIndex = 2
btnClose.Parent = titleBar

local btnToggle = Instance.new("TextButton")
btnToggle.Size = UDim2.new(1, -16, 0, 30)
btnToggle.Position = UDim2.new(0, 8, 0, 36)
btnToggle.Font = Enum.Font.GothamBold
btnToggle.TextSize = 14
btnToggle.Text = "ESP: OFF"
btnToggle.BackgroundColor3 = Color3.fromRGB(80, 30, 30)
btnToggle.TextColor3 = Color3.fromRGB(240, 240, 240)
btnToggle.Parent = mainFrame

local txtFilter = Instance.new("TextBox")
txtFilter.Size = UDim2.new(1, -16, 0, 24)
txtFilter.Position = UDim2.new(0, 8, 0, 76)
txtFilter.Font = Enum.Font.Gotham
txtFilter.TextSize = 14
txtFilter.PlaceholderText = "Teams (comma separated)"
txtFilter.ClearTextOnFocus = false
txtFilter.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
txtFilter.TextColor3 = Color3.fromRGB(240, 240, 240)
txtFilter.Parent = mainFrame

-- Minimized bar (collapsible view)
local minBar = Instance.new("TextButton")
minBar.Name = "ESPMinBar"
minBar.Size = UDim2.new(0, 100, 0, 26)
minBar.Position = mainFrame.Position
minBar.Font = Enum.Font.GothamBold
minBar.TextSize = 14
minBar.Text = "ESP +"
minBar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
minBar.TextColor3 = Color3.fromRGB(235, 235, 235)
minBar.Visible = false
minBar.Active = true
minBar.Parent = screenGui

-- Rescue hotkey: RightControl toggles the full panel (in case it gets hidden)
UserInput.InputBegan:Connect(function(input, gpe)
  if gpe then return end
  if input.KeyCode == Enum.KeyCode.RightControl then
    local show = not mainFrame.Visible and not minBar.Visible
    if show then
      mainFrame.Visible = true
    else
      mainFrame.Visible = not mainFrame.Visible
      minBar.Visible = false
    end
  end
end)

-- Draggable helper
local function makeDraggable(frame, handle)
  local dragging, dragInput, dragStart, startPos
  local function update(input)
    local delta = input.Position - dragStart
    frame.Position = UDim2.new(
      startPos.X.Scale, startPos.X.Offset + delta.X,
      startPos.Y.Scale, startPos.Y.Offset + delta.Y
    )
  end
  handle.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
      dragging = true
      dragStart = input.Position
      startPos = frame.Position
      input.Changed:Connect(function()
        if input.UserInputState == Enum.UserInputState.End then
          dragging = false
        end
      end)
    end
  end)
  handle.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
      dragInput = input
    end
  end)
  UserInput.InputChanged:Connect(function(input)
    if dragging and input == dragInput then
      update(input)
    end
  end)
end
makeDraggable(mainFrame, titleBar)
makeDraggable(minBar, minBar)

-- Collapse/expand behavior
btnMin.MouseButton1Click:Connect(function()
  minBar.Position = mainFrame.Position
  mainFrame.Visible = false
  minBar.Visible = true
end)
minBar.MouseButton1Click:Connect(function()
  mainFrame.Position = minBar.Position
  mainFrame.Visible = true
  minBar.Visible = false
end)

-- Utils
local function trim(s) return (s:match("^%s*(.-)%s*$")) end

local function updateFilters(text)
  teamFilters = {}
  for name in (text or ""):lower():gmatch("([^,]+)") do
    name = trim(name)
    if name ~= "" then table.insert(teamFilters, name) end
  end
end

txtFilter:GetPropertyChangedSignal("Text"):Connect(function()
  updateFilters(txtFilter.Text)
  for plr, data in pairs(highlights) do
    local teamName = (plr.Team and plr.Team.Name:lower()) or ""
    local pass = (#teamFilters == 0) or (teamName ~= "" and table.find(teamFilters, teamName) ~= nil)
    if data.hl then data.hl.Enabled = espEnabled and pass end
    if data.bb then data.bb.Enabled = espEnabled and pass end
  end
end)

-- Health color mapping (outline)
local function healthToColor(hp, maxHp)
  local frac = 0
  if maxHp and maxHp > 0 then frac = math.clamp(hp / maxHp, 0, 1) end
  return Color3.fromHSV(frac * 0.33, 1, 1) -- red->yellow->green
end

local function getAdorneePart(character)
  if not character then return nil end
  return character:FindFirstChild("Head")
      or character:FindFirstChild("HumanoidRootPart")
      or character:FindFirstChildWhichIsA("BasePart")
end

local function destroyESP(plr)
  local data = highlights[plr]
  if not data then return end
  if data.conns then
    for _, c in ipairs(data.conns) do pcall(function() c:Disconnect() end) end
  end
  if data.bb then pcall(function() data.bb:Destroy() end) end
  if data.hl then pcall(function() data.hl:Destroy() end) end
  highlights[plr] = nil
end

local function applyESP(plr)
  destroyESP(plr)
  local char = plr.Character
  if not char then return end
  local humanoid = char:FindFirstChildOfClass("Humanoid")
  if not humanoid then return end

  -- Highlight
  local hl = Instance.new("Highlight")
  hl.Name = "ESP_Highlight"
  hl.Parent = char
  hl.FillColor = Color3.fromRGB(0, 255, 0)
  hl.FillTransparency = 0.6
  hl.OutlineTransparency = 0
  hl.OutlineColor = healthToColor(humanoid.Health, humanoid.MaxHealth)
  hl.Enabled = false

  -- Small name tag
  local adornee = getAdorneePart(char)
  local bb = Instance.new("BillboardGui")
  bb.Name = "ESP_Name"
  bb.Size = UDim2.new(0, 80, 0, 16)
  bb.StudsOffset = Vector3.new(0, 3, 0)
  bb.AlwaysOnTop = true
  bb.Enabled = false
  pcall(function() bb.MaxDistance = 150 end)
  if adornee then
    bb.Adornee = adornee
    bb.Parent = adornee
  else
    bb.Parent = char
  end
  local nameLbl = Instance.new("TextLabel")
  nameLbl.BackgroundTransparency = 1
  nameLbl.Size = UDim2.new(1, 0, 1, 0)
  nameLbl.Font = Enum.Font.Gotham
  nameLbl.TextSize = 12
  nameLbl.Text = plr.DisplayName
  nameLbl.TextColor3 = Color3.fromRGB(255, 255, 255)
  nameLbl.TextStrokeTransparency = 0.5
  nameLbl.Parent = bb

  local conns = {}
  table.insert(conns, humanoid.HealthChanged:Connect(function(hp)
    hl.OutlineColor = healthToColor(hp, humanoid.MaxHealth)
  end))
  table.insert(conns, char.ChildAdded:Connect(function(child)
    if not bb.Adornee and child:IsA("BasePart") and (child.Name == "Head" or child.Name == "HumanoidRootPart") then
      bb.Adornee = child
      bb.Parent = child
    end
  end))
  table.insert(conns, humanoid.Died:Connect(function() destroyESP(plr) end))
  table.insert(conns, plr.CharacterRemoving:Connect(function() destroyESP(plr) end))

  highlights[plr] = { hl = hl, bb = bb, conns = conns }

  local teamName = (plr.Team and plr.Team.Name:lower()) or ""
  local pass = (#teamFilters == 0) or (teamName ~= "" and table.find(teamFilters, teamName) ~= nil)
  hl.Enabled = espEnabled and pass
  bb.Enabled = espEnabled and pass
end

local function ensureESPForAll()
  for _, plr in ipairs(Players:GetPlayers()) do
    if plr ~= localPlayer and plr.Character then
      if not highlights[plr] then
        applyESP(plr)
      else
        local data = highlights[plr]
        local teamName = (plr.Team and plr.Team.Name:lower()) or ""
        local pass = (#teamFilters == 0) or (teamName ~= "" and table.find(teamFilters, teamName) ~= nil)
        if data.hl then data.hl.Enabled = espEnabled and pass end
        if data.bb then data.bb.Enabled = espEnabled and pass end
      end
    end
  end
end

-- Toggle
btnToggle.MouseButton1Click:Connect(function()
  espEnabled = not espEnabled
  btnToggle.Text = espEnabled and "ESP: ON" or "ESP: OFF"
  btnToggle.BackgroundColor3 = espEnabled and Color3.fromRGB(30, 80, 30) or Color3.fromRGB(80, 30, 30)
  if espEnabled then
    ensureESPForAll()
  else
    for _, data in pairs(highlights) do
      if data.hl then data.hl.Enabled = false end
      if data.bb then data.bb.Enabled = false end
    end
  end
end)

-- Close: full cleanup
btnClose.MouseButton1Click:Connect(function()
  espEnabled = false
  for plr in pairs(highlights) do destroyESP(plr) end
  screenGui:Destroy()
  pcall(function() script:Destroy() end)
end)

-- Player lifecycle
local function wirePlayer(plr)
  if plr == localPlayer then return end
  plr:GetPropertyChangedSignal("Team"):Connect(function()
    local data = highlights[plr]
    if data then
      local teamName = (plr.Team and plr.Team.Name:lower()) or ""
      local pass = (#teamFilters == 0) or (teamName ~= "" and table.find(teamFilters, teamName) ~= nil)
      if data.hl then data.hl.Enabled = espEnabled and pass end
      if data.bb then data.bb.Enabled = espEnabled and pass end
    end
  end)
  plr.CharacterAdded:Connect(function()
    task.wait() -- give Humanoid/head a tick to exist
    if espEnabled then applyESP(plr) else destroyESP(plr) end
  end)
  if plr.Character then
    if espEnabled then applyESP(plr) else destroyESP(plr) end
  end
end

Players.PlayerAdded:Connect(wirePlayer)
Players.PlayerRemoving:Connect(function(plr) destroyESP(plr) end)
for _, plr in ipairs(Players:GetPlayers()) do wirePlayer(plr) end

-- Initialize filters
do updateFilters(txtFilter.Text) end
